<?php
 // $Id$

 /**
  * @file
  *   A 'apollo' implementation of the 'solr' service type.
  */

/**
 * A class containing the 'apollo' implementation of the 'solr' service.
 *
 * This class is conditionally loaded when the "--solr_service_type=apollo"
 * option is passed to provision-save commands run on servers.
 *
 * The above flag is generated by the hosting counterpart of this class, which
 * provides the front end to configure all these fields.
 *
 * The responsibilities of this class include responding and saving any
 * values that are passed to it, and also to override the portions of
 * the public API for this service that are necessary.
 */
class provisionService_solr_apollo extends provisionService_solr {
 /**
  * Some common options handled upstream by the base service classes.
  */

 /**
  *   This service needs to have a port specified for it.
  */
  public $has_port = TRUE;

 /**
  *   The default value for the port input.
  */
  function default_port() {
    return 8983;
  }

 /**
  *   This service needs to be restarted with a shell command.
  */
  public $has_restart_cmd = TRUE;

 /**
  *   The default value for the restart command input.
  */
  function default_restart_cmd() {
    //return "sudo /etc/init.d/apollo restart";
    return "echo 'hi'";
  }


  /**
   * Initialize this class, including option handling.
   */
  function init() {
    // REMEMBER TO CALL THE PARENT!
    parent::init();

    /**
     * Register configuration classes for the create_config / delete_config methods.
     */
    $this->configs['server'][] = 'provisionConfig_solr';
  }

  function init_server() {
    parent::init_server();

    $this->server->setProperty('apollo_search_server', 0);
  }

  function save_server() {
    //$this->server->shell_exec($path . ' status');
    $this->server->apollo_search_server = 1;
  }

  /*
  function verify_server_cmd() {
    provision_file()->copy(dirname(__FILE__) . '/schema.xml', $this->server->include_path . '/schema.xml');
    $this->sync($this->server->include_path . '/schema.xml');
    provision_file()->copy(dirname(__FILE__) . '/solrconfig.xml', $this->server->include_path . '/solrconfig.xml');
    $this->sync($this->server->include_path . '/solrconfig.xml');
    // Call the parent at the end. it will restart the server when it finishes.
    parent::verify_server_cmd();
  }
  //*/

  function verify_site_cmd() {
    provision_file()->copy(dirname(__FILE__) . '/schema.xml', $this->server->include_path . '/schema.xml');
    $this->sync($this->server->include_path . '/schema.xml');
    provision_file()->copy(dirname(__FILE__) . '/solrconfig.xml', $this->server->include_path . '/solrconfig.xml');
    $this->sync($this->server->include_path . '/solrconfig.xml');
    // Call the parent at the end. it will restart the server when it finishes.
    parent::verify_site_cmd();
  }


  function apollo_get_path() {
    $path = '';

    if (provision_file()->exists('/usr/local/bin/apollo')->status()) {
      $path = "/usr/local/bin/apollo";
    }
    elseif (provision_file()->exists('/usr/bin/apollo')->status()) {
      $path = "/usr/bin/apollo";
    }
    else {
      // Why were we sometimes getting here?
      //return;
      $path = "/usr/bin/apollo";
    }

    return $path;
  }

  function solr_core_exists($solr_core_name) {
    //$this->server->shell_exec('sudo ' . $path . ' status ' . $solr_core_name);
    $this->server->shell_exec('cat /etc/hostname');
    drush_log('*** solr_core_exists: hostname: ' . print_r(drush_shell_exec_output(), TRUE), 'warning');
    $this->server->shell_exec('echo hi');
    drush_log('** exists: ' . print_r(drush_shell_exec_output(), TRUE), 'warning');
    $exists = preg_match("/$solr_core_name/", implode('', drush_shell_exec_output()), $match);
    if (!empty($match)) {
      return TRUE;
    }

    return FALSE;
  }

  function create_solr_core($solr_core_name) {
    drush_log('*** oh hai 1', 'warning');
    $path = $this->apollo_get_path();
    drush_log('*** apollo_get_path: ' . print_r($path, TRUE), 'warning');
    $this->server->shell_exec('cat /etc/hostname');
    drush_log('*** create_solr_core hostname: ' . print_r(drush_shell_exec_output(), TRUE), 'warning');
    drush_log('*** this->remote_host: ' . print_r($this->remote_host, TRUE), 'warning');

    //$this->server->shell_exec('sudo ' . $path . ' create ' . $solr_core_name);
    return true;
  }

  function purge_solr_core($solr_core_name) {
    $path = apollo_get_path();

    //$this->server->shell_exec('sudo ' . $path . ' stop');
    //$this->server->shell_exec('sudo ' . $path . ' purge ' . $core_name);
    //$this->server->shell_exec('sudo ' . $path . ' start');
  }

  function connect($name) {
    // We can test this by connecting to http://<host>:<port>/solr/<solr_core_name>/admin/
    // for now return TRUE
    return TRUE;
  }


  function parse_configs() {
    return $this->restart();
  }
}

